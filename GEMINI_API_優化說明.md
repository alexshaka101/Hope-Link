# Gemini API 整合與優化說明

## ✅ 已完成的優化

### 1. **改進系統提示詞** 
- ✨ 增加了「回應簡短」的明確要求（最多30字）
- ✨ 強調「自然、口語化」的對話風格
- ✨ 加入「根據孩子回應調整話題」的智能回應機制

### 2. **增強對話歷史功能**
- 📚 AI 現在會記住最近 5 輪對話（10條訊息）
- 🔄 對話更連貫，AI 能夠參考之前的內容
- 💡 避免重複問相同的問題

### 3. **強化錯誤處理與日誌**
- 📊 詳細的 API 呼叫日誌
- 🐛 更清楚的錯誤訊息
- 🔍 便於 Debug 和追蹤問題

---

## 🧪 測試步驟

### Step 1: 啟動本地伺服器
本地伺服器已經在 `http://localhost:8080` 運行中

### Step 2: 開啟網頁
在瀏覽器中訪問：
```
http://localhost:8080
```

### Step 3: 開啟開發者工具
按 `F12` 或 `Ctrl + Shift + J`（Mac: `Cmd + Option + J`）

### Step 4: 測試 API 連接
在 Console 中執行：
```javascript
testGeminiAPI()
```

**預期結果：**
```
🧪 開始測試 Gemini API...
📡 API URL: https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent
🔑 API Key: AIzaSyDEXY...
📤 測試提示詞: 你好！請用一句溫暖的話回應我。
🤖 正在呼叫 Gemini API...
📝 提示詞長度: XXX
✅ API 回應成功
💬 AI 回應內容: 你好呀！很高興認識你～
📊 回應長度: XX 字元
🎯 當前對話階段: 1
📈 對話輪數: 0
✅ API 測試成功！
✨ 系統運作正常，可以開始使用！
```

### Step 5: 測試實際對話
1. 點擊「我是孩子 🧒」
2. 點擊「開始使用」
3. 輸入測試訊息，例如：
   - 「你好！」
   - 「我喜歡吃麵包」
   - 「我聽到了～繼續說吧！」

4. 觀察 Console 中的詳細日誌：

```javascript
// 每次對話都會顯示：
🤖 正在呼叫 Gemini API...
📝 提示詞長度: 578
✅ API 回應成功
💬 AI 回應內容: 麵包好好吃喔！你喜歡什麼口味的呢？😊
📊 回應長度: 18 字元
🎯 當前對話階段: 1
📈 對話輪數: 1
```

---

## 🔍 驗證 AI 是否真正在工作

### 方法 1：檢查回應的多樣性
AI 生成的回應**不會重複**，每次都會根據上下文給出不同的回應。

**測試案例：**
```javascript
// 多次說「你好」，觀察回應是否不同
輸入 1: 你好
回應 1: 你好呀！很高興認識你～✨

輸入 2: 你好
回應 2: 嗨嗨～今天過得怎麼樣？😊
```

### 方法 2：檢查對話連貫性
AI 會記住之前的對話，並在回應中提及。

**測試案例：**
```javascript
輸入 1: 我喜歡吃麵包
回應 1: 麵包好好吃喔！你喜歡什麼口味的呢？

輸入 2: 我喜歡巧克力口味
回應 2: 巧克力麵包超棒的！甜甜的很好吃對吧～

輸入 3: 你還記得我喜歡什麼嗎？
回應 3: 記得呀～你喜歡吃巧克力麵包！💚
```

### 方法 3：檢查 Console 日誌
如果 API 正常工作，Console 會顯示：
- ✅ `API 回應成功`
- ✅ `AI 回應內容: [動態內容]`
- ❌ **不會顯示** `使用備用回應機制`

---

## 🎯 對話階段測試

系統會根據對話輪數自動進階：

### 階段 1：建立信任（0-4 輪）
- 話題：興趣、喜好、日常生活
- 測試：問「你喜歡什麼顏色？」
- AI 會問類似：「你最喜歡玩什麼遊戲呢？」

### 階段 2：探索家庭（5-9 輪）
- 話題：家庭環境、日常習慣
- 測試：多聊幾輪後，AI 會自然問到家庭相關問題
- AI 會問類似：「你家裡有養小動物嗎？」

### 階段 3：情感深入（10+ 輪）
- 話題：記憶、情感連結
- 測試：持續對話 10 輪以上
- AI 會問類似：「有什麼特別的回憶讓你印象深刻嗎？」

---

## 📊 查看系統狀態

在 Console 中執行以下指令：

```javascript
// 查看整體狀態
console.log('系統狀態:', window.ChildAIChat);

// 查看對話階段
console.log('當前階段:', window.ChildAIChat.conversationStage);

// 查看對話輪數
console.log('對話輪數:', window.ChildAIChat.messageCount);

// 查看對話歷史
console.log('對話歷史:', window.ChildAIChat.conversationHistory);

// 查看提取的關鍵詞
console.log('關鍵詞:', window.ChildAIChat.extractedKeywords);

// 查看生成的記憶卡
const cards = JSON.parse(localStorage.getItem('hopelink-memory-cards'));
console.log('記憶卡數量:', cards?.length || 0);
console.table(cards);
```

---

## 🐛 常見問題排查

### 問題 1：API 一直使用備用回應
**症狀：**
```
⚠️ 使用備用回應機制
💬 AI 回應: 我聽到了～繼續說吧！
```

**可能原因：**
1. ❌ API Key 無效
2. ❌ 網路連接問題
3. ❌ CORS 錯誤（未使用本地伺服器）
4. ❌ API 配額用完

**解決方法：**
- 檢查 Console 中的錯誤訊息
- 確保使用本地伺服器（`http://localhost:8080`）
- 驗證 API Key 是否有效

### 問題 2：CORS 錯誤
**症狀：**
```
Access to fetch at '...' has been blocked by CORS policy
```

**解決方法：**
確保使用本地伺服器，而不是直接開啟 `file://` 路徑

### 問題 3：回應太長或太制式
**解決方法：**
已經在系統提示詞中加入「最多30字」的限制，AI 會自動調整回應長度。

---

## 💡 優化效果對比

### 優化前：
```
AI: 你好！我是光光。我是一個專門為孩子設計的 AI 助手，我的目的是要幫助你...
（長達 100+ 字的說明）
```

### 優化後：
```
AI: 你好呀！很高興認識你～✨
（簡短、自然、親切）
```

---

## 🎉 確認 API 正常工作的標誌

✅ **Console 中顯示：**
- `✅ API 回應成功`
- `💬 AI 回應內容: [動態內容]`
- `📊 回應長度: XX 字元`

✅ **對話體驗：**
- 回應簡短、自然（不超過 30 字）
- 每次回應都不同（有多樣性）
- AI 能記住之前的對話內容
- 話題會隨著對話輪數逐步深入

✅ **不會出現：**
- ❌ 重複的預設回應（「我聽到了～繼續說吧！」）
- ❌ 長篇大論的制式回答
- ❌ 無法記住之前對話內容

---

## 📞 需要協助？

如果遇到問題，請提供：
1. Console 中的完整錯誤訊息
2. 輸入的測試訊息
3. 實際收到的回應
4. 系統狀態（執行 `console.log(window.ChildAIChat)`）

---

**更新日期**: 2025-10-20  
**優化版本**: 2.0  
**API 模型**: gemini-1.5-flash  
**狀態**: ✅ 已優化並測試完成

