# 家長端系統功能說明

## 📋 功能概述

家長端系統是 HopeLink 平台的核心功能之一，用於幫助失散孩子的家長透過記憶驗證找回自己的孩子。系統整合了 AI 語意分析、記憶配對和安全驗證機制。

## 🎯 主要流程

### 1️⃣ 輸入孩童資訊
家長首先需要提供以下資訊：
- **孩童姓名** (必填)
- **年齡** (必填)
- **走失地區** (必填)
- **客觀描述** (選填)：孩子的外貌特徵、性格、興趣愛好、家庭背景等

### 2️⃣ AI 語意配對
系統會自動：
- 從資料庫中獲取孩童端生成的記憶卡
- 使用 AI 進行語意分析和配對
- 計算配對分數（基於年齡、地點、關鍵字等）
- 按照配對度排序顯示結果

### 3️⃣ 顯示搜尋結果
搜尋結果會顯示：
- **配對度**：百分比顯示 (高配對 ≥80%, 中配對 ≥60%)
- **案件編號**：唯一識別碼
- **記錄時間**：孩童對話的時間
- **對話階段**：初步對話/深入交流/情感連結
- **關鍵記憶數量**：收集到的記憶關鍵字數量
- **語言**：孩童使用的語言

### 4️⃣ 記憶驗證問題
選擇案件後，系統會：
- 基於孩童的敘事生成 3 個驗證問題
- 問題涵蓋：家庭成員、寵物、地點、物品、活動等
- 使用 Gemini AI 生成自然的問題
- 每個問題都標註來源（來自哪段記憶）

**驗證問題範例**：
- 🏠 「孩子在對話中提到了居住或常去的地方，請問是哪裡？」
- 🐾 「孩子有提到家裡的寵物，請問是什麼動物？」
- 👨‍👩‍👧 「孩子在對話中提到了家庭成員，請問是誰？」

### 5️⃣ 答案驗證與語意分析
系統會：
- 收集家長的所有答案
- 使用 Gemini AI 進行語意相似度分析
- 計算每個答案與孩童記憶的相似度
- 計算平均相似度
- 判定是否通過驗證（≥80%）

### 6️⃣ 驗證結果
- **通過**（≥80%）：
  - 顯示各問題的驗證結果
  - 提供「申請重聚」按鈕
  - 說明後續 NGO 人工核實流程

- **未通過**（<80%）：
  - 顯示各問題的相似度
  - 說明未通過原因
  - 提供重新嘗試機會（如有剩餘次數）
  - 或顯示冷卻時間

### 7️⃣ 安全機制
為防止暴力破解，系統實施：
- **最大嘗試次數**：3次
- **冷卻時間**：30分鐘
- 超過次數限制後需等待冷卻時間
- 可聯繫 NGO 工作人員尋求協助

## 🔧 技術實現

### 檔案結構
```
parent-system.js      # 家長端核心邏輯
index.html            # 新增家長端模態視窗
styles.css            # 家長端樣式
```

### 核心函數

#### 1. 搜尋配對
```javascript
searchMatchingCases(searchData)
```
- 從 localStorage 讀取孩童記憶卡
- 計算配對分數
- 返回排序後的匹配結果

#### 2. 生成驗證問題
```javascript
generateVerificationQuestions(memoryCard)
```
- 分析記憶卡的語意特徵
- 使用 Gemini API 生成自然問題
- 備用：使用模板生成問題

#### 3. 驗證答案
```javascript
verifyAnswers(answers)
```
- 逐一驗證每個答案
- 計算語意相似度
- 返回驗證結果

#### 4. 語意相似度計算
```javascript
calculateSemanticSimilarity(userAnswer, expectedKeywords)
```
- 使用 Gemini AI 分析語意相似度
- 返回 0-1 之間的分數
- 備用：簡單關鍵字匹配

## 🎨 使用介面

### 模態視窗
1. **parentSearchModal**：輸入孩童資訊
2. **parentResultsModal**：顯示搜尋結果
3. **parentVerificationModal**：記憶驗證問題
4. **parentVerificationResultModal**：驗證結果
5. **loadingOverlay**：載入動畫

### 視覺設計
- 配對度顯示：
  - 高配對（≥80%）：綠色邊框
  - 中配對（≥60%）：黃色邊框
  - 低配對（<60%）：灰色邊框

- 驗證結果：
  - 通過：綠色圖示和強調色
  - 失敗：紅色圖示和強調色

## 📊 資料結構

### 搜尋資料
```javascript
{
  childName: "...",
  childAge: "...",
  lostArea: "...",
  description: "..."
}
```

### 配對結果
```javascript
{
  caseId: "...",
  shortHash: "...",
  matchScore: 0.85,
  memoryCard: {...},
  timestamp: "...",
  language: "zh",
  conversationStage: 3,
  keywordCount: 15
}
```

### 驗證問題
```javascript
{
  question: "...",
  category: "family",
  expectedKeywords: ["媽媽", "爸爸"],
  memorySource: "家庭成員記憶"
}
```

### 驗證結果
```javascript
{
  results: [...],
  averageSimilarity: 0.85,
  passed: true,
  attemptCount: 1,
  remainingAttempts: 2
}
```

## 🔐 安全與隱私

### 資料保護
- 所有資料加密處理
- 不直接儲存個人身份資訊
- 使用語意特徵進行配對

### 驗證機制
- 次數限制防止暴力破解
- 冷卻時間保護系統
- 語意分析而非字面匹配

### NGO 人工核實
驗證通過後仍需：
1. NGO 工作人員進行人工核實
2. 確認雙方身份
3. 安排安全的會面環境
4. 在專業人員陪同下完成重聚

## 🧪 測試方法

### 準備測試資料
1. 先使用孩童端生成記憶卡：
   - 點擊「孩童端」→「開始使用」
   - 與 AI 進行對話
   - 提及家庭成員、地點、物品等資訊

2. 使用家長端進行搜尋：
   - 點擊「家長端」→「開始使用」
   - 輸入對應的孩童資訊
   - 查看搜尋結果

3. 進行記憶驗證：
   - 選擇配對度高的案件
   - 回答驗證問題
   - 查看驗證結果

### 測試場景

#### 場景 1：高配對度驗證通過
1. 孩童端提到：「我家有一隻狗」、「住在台北」、「媽媽會做蛋糕」
2. 家長端輸入：年齡、台北、有養狗
3. 驗證問題回答：狗、台北、做蛋糕
4. 預期結果：驗證通過（≥80%）

#### 場景 2：驗證失敗但可重試
1. 回答與記憶不完全相符
2. 相似度 < 80%
3. 預期結果：顯示剩餘嘗試次數

#### 場景 3：超過次數限制
1. 連續 3 次驗證失敗
2. 預期結果：顯示冷卻時間（30分鐘）

## 🚀 未來優化方向

### 功能增強
- [ ] 支援多輪對話式驗證
- [ ] 引入影像或語音輔助驗證
- [ ] 機器學習優化配對算法
- [ ] 多語言支援完善

### 性能優化
- [ ] 後端 API 整合
- [ ] 資料庫索引優化
- [ ] 快取機制
- [ ] 並行處理

### 安全強化
- [ ] 多因素驗證
- [ ] 區塊鏈記錄
- [ ] 端到端加密
- [ ] 異常行為偵測

## 📞 聯繫支援

如有任何問題或需要協助：
- 緊急通報熱線：+886 1234-5678（24小時）
- 線上表單：[填寫表單]
- 電子郵件：support@hopelink.org

---

## 🎓 開發者說明

### 環境需求
- Gemini API Key
- 現代瀏覽器（支援 ES6+）
- localStorage 支援

### API 配置
在 `parent-system.js` 中配置：
```javascript
const GEMINI_API_KEY = '您的API金鑰';
const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
```

### 驗證設定
在 `VERIFICATION_CONFIG` 中調整：
```javascript
const VERIFICATION_CONFIG = {
    maxAttempts: 3,           // 最大嘗試次數
    cooldownMinutes: 30,      // 冷卻時間（分鐘）
    similarityThreshold: 0.8, // 相似度門檻
    questionsPerRound: 3      // 每輪問題數量
};
```

### 除錯工具
開啟瀏覽器控制台可查看：
- 配對分數計算過程
- AI 生成的問題
- 語意相似度分析
- 驗證流程日誌

---

**HopeLink - 讓故事成為重聚的橋樑** 💚

